<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project>

<sequence basedir="." >

	<order name="create_all_vm" >
		<echo message="Creating virtual machines ..." />

		<foreach	items="./environment//instance"
					item-name="srv" >
			<new-machine target="§[srv]§" />
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<property name="adm_ip" value="§[ if( '§[adm_ip]§' != '' ) then ' (IP: §[adm_ip]§)' else '' ]§" />
			<echo message="+ virtual machine '§[§[srv]§/@instance-id]§' created§[adm_ip]§." />
		</foreach>

		<echo message="-- Virtual machines created." />

		<call orders="update_disk_devices" />
		<call orders="update_network_devices" />
		<call orders="update_firewall"/>

 	</order>

	<order name="destroy_all_vm" >
		<echo message="Destroying virtual machines ..." />

		<foreach	items="./environment//instance[exists(@instance-id)]"
					item-name="srv" >
			<property name="id" value="§[§[srv]§/@instance-id]§" />
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<property name="adm_ip" value="§[ if( '§[adm_ip]§' != '' ) then ' (IP: §[adm_ip]§)' else '' ]§" />
			<delete-machine target="§[srv]§" />
			<echo message="+ virtual machine '§[id]§' destroyed§[adm_ip]§." />
		</foreach>

		<echo message="-- Virtual machines destroyed." />

		<call orders="update_firewall"/>
	</order>

	<order name="start_all_vm" >
		<echo message="Starting virtual machines ..." />

		<foreach	items="./environment//instance[exists(@instance-id)]"
					item-name="srv" >
			<start-machine target="§[srv]§" />
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<echo message="+ virtual machine '§[§[srv]§/@instance-id]§' started (IP: §[adm_ip]§)." />
		</foreach>

		<echo message="-- Virtual machines started." />

		<call orders="update_firewall"/>
	</order>
		
	<order name="stop_all_vm" >
		<echo message="Stopping virtual machines ..." />

		<foreach	items="./environment//instance[exists(@instance-id)]"
					item-name="srv" >
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<property name="adm_ip" value="§[ if( '§[adm_ip]§' != '' ) then ' (IP: §[adm_ip]§)' else '' ]§" />
			<stop-machine target="§[srv]§" />
			<echo message="+ virtual machine '§[§[srv]§/@instance-id]§' stopped§[adm_ip]§." />
		</foreach>

		<echo message="-- Virtual machines stopped." />

		<call orders="update_firewall"/>
	</order>
	
	<order name="resize_all_vm" >
		<echo message="Resing virtual machines ..." />

		<foreach	items="./environment//instance[exists(@instance-id)]"
					item-name="srv" >
			<resize-machine target="§[srv]§" instance-type="m1.small" />
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<property name="adm_ip" value="§[ if( '§[adm_ip]§' != '' ) then ' (IP: §[adm_ip]§)' else '' ]§" />
			<echo message="+ virtual machine '§[§[srv]§/@instance-id]§' resized§[adm_ip]§." />
		</foreach>

		<echo message="-- Virtual machines resized." />
	</order>

	<order name="update_disk_devices" >
		<echo message="Updating disk devices ..." />

		<foreach	items="./environment//instance[exists(@instance-id)]"
					item-name="srv" >
			<update-disk-devices target="§[srv]§" />
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<property name="adm_ip" value="§[ if( '§[adm_ip]§' != '' ) then ' (IP: §[adm_ip]§)' else '' ]§" />
			<echo message="+ virtual machine '§[§[srv]§/@instance-id]§' disk devices updated§[adm_ip]§." />
		</foreach>

		<echo message="-- Disk devices updated." />		
	</order>

	<order name="update_network_devices" >
		<echo message="Updating network devices ..." />

		<foreach	items="./environment//instance[exists(@instance-id)]"
					item-name="srv" >
			<update-network-devices target="§[srv]§" />
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<property name="adm_ip" value="§[ if( '§[adm_ip]§' != '' ) then ' (IP: §[adm_ip]§)' else '' ]§" />
			<echo message="+ virtual machine '§[§[srv]§/@instance-id]§' network devices updated§[adm_ip]§." />
		</foreach>

		<echo message="-- Network devices updated." />		
	</order>

	<order name="update_firewall" >
		<echo message="Updating FireWall rules ..." />

		<foreach	items="./environment//instance[exists(@instance-id)]"
					item-name="srv" >
			<update-firewall target="§[srv]§" />
			<property name="adm_ip" value="§[ melody:getManagementNetworkHost(§[srv]§) ]§" />
			<property name="adm_ip" value="§[ if( '§[adm_ip]§' != '' ) then ' (IP: §[adm_ip]§)' else '' ]§" />
			<echo message="+ virtual machine '§[§[srv]§/@instance-id]§' fireWall rules updated§[adm_ip]§." />
		</foreach>

		<echo message="-- FireWall rules updated." />		
	</order>

</sequence>
