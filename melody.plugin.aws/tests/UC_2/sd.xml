<?xml version="1.0" encoding="UTF-8"?>

<sequence default="all" basedir="." >

	<order name="ingress" >
		<echo message="Updating FireWall rules ..." />

		<foreach	items="./environment/serverAWS//instance[exists(@AWS_instance_Id)]"
					itemName="srv" >
			<ingressMachine	target="§[srv]§"/>
			<echo message="+ fwrules updated for instance '§[§[srv]§/@AWS_instance_Id]§'." />
		</foreach>

		<echo message="-- FireWall rules updated." />		
	</order>

	<order name="update_disks" >
		<echo message="Updating disks ..." />

		<foreach	items="./environment/serverAWS//instance"
					itemName="srv" >
			<updateDisks	target="§[srv]§" />
			<echo message="+ disks updated for instance '§[§[srv]§/@AWS_instance_Id]§'." />
		</foreach>

		<echo message="-- Disks updated." />		
	</order>

	<order name="create_env" >
		<echo message="Creating instances ..." />

		<foreach	items="./environment/serverAWS//instance"
					itemName="srv" >
			<newMachine	target="§[srv]§" />
			<echo message="+ instance '§[§[srv]§/@AWS_instance_Id]§' created (IP: §[§[srv]§/@IP_pub]§)." />
		</foreach>

		<echo message="-- All instances created." />

		<call orders="ingress" />

		<call orders="update_disks" />
	</order>
		
	<order name="stop_env" >
		<echo message="Stopping instances ..." />

		<foreach	items="./environment/serverAWS//instance"
					itemName="srv" >
			<stopMachine	target="§[srv]§" />
			<echo message="+ instance '§[§[srv]§/@AWS_instance_Id]§' stopped." />
		</foreach>

		<echo message="-- All instances stopped." />

		<call orders="ingress" />
	</order>
	
	<order name="resize_env" >
		<echo message="Resing instances ..." />

		<foreach	items="./environment/serverAWS//instance"
					itemName="srv" >
			<resizeMachine	target="§[srv]§" />
			<echo message="+ instance '§[§[srv]§/@AWS_instance_Id]§' resized." />
		</foreach>

		<echo message="-- All instances resized." />
	</order>

	<order name="start_env" >
		<echo message="Starting instances ..." />

		<foreach	items="./environment/serverAWS//instance"
					itemName="srv" >
			<startMachine	target="§[srv]§" />
			<echo message="+ instance '§[§[srv]§/@AWS_instance_Id]§' started (IP: §[§[srv]§/@IP_pub]§)." />
		</foreach>

		<echo message="-- All instances started." />

		<call orders="ingress" />
	</order>
	
	<order name="destroy_env" >
		<echo message="Destroying instances ..." />

		<foreach	items="./environment/serverAWS//instance"
					itemName="srv" >
			<property name="id" value="§[§[srv]§/@AWS_instance_Id]§" />
			<deleteMachine	target="§[srv]§" />
			<echo message="+ instance '§[id]§' destroyed." />
		</foreach>

		<echo message="-- All instances destroyed." />

		<call orders="ingress" />
	</order>
	
	
	<order name="upload_ejbca" >
		<echo message="Uploading EJBCA ..." />

		<foreach	items="./environment/serverAWS//instance"
					itemName="srv" >
			<property name="id" value="§[§[srv]§/@AWS_instance_Id]§" />
			<upload host="§[§[srv]§/@IP_pub]§" login="jboss" keyPairName="id_rsa_aws" >
				<resources		localBaseDir="/home/gcornet/Documents/DUTCH TAX OFFICE"
								match="ejbca_4_0_10.zip"
								remoteBaseDir="/tmp/upload/ejbca" />
				<resources		localBaseDir="/home/gcornet/Documents/REDHAT/JBOSS EAP/EAP 5/archives"
								match="jboss-eap-5.1.2.zip"
								remoteBaseDir="/tmp/upload/jboss" />
				<resources		localBaseDir="/home/gcornet/Documents/DUTCH TAX OFFICE"
								match="apache-ant-1.8.4-bin.zip"
								remoteBaseDir="/tmp/upload/ant" />
			</upload>
			<echo message="+ EJBCA uploaded on instance '§[id]§'." />
		</foreach>

		<echo message="-- All EJBCA upload done." />
	</order>

	<order name="all" >
		<call	orders="create_env" />
		<sleep	millis="2000" />
		<call	orders="stop_env" />
		<sleep	millis="2000" />
		<call	orders="start_env" />
		<sleep	millis="2000" />
		<call	orders="destroy_env" />
	</order>

</sequence>
