<?xml version="1.0" encoding="UTF-8"?>

<sequence default="all" basedir="." >

	<order name="ingress" >
		<echo message="Updating FireWall rules ..." />

		<foreach	items="./environment//instance[exists(@instanceId)]"
					itemName="srv" >
			<ingressMachine	target="§[srv]§" />
			<echo message="+ fwrules updated for instance '§[§[srv]§/@instanceId]§'." />
		</foreach>

		<echo message="-- FireWall rules updated." />		
	</order>

	<order name="update_disks" >
		<echo message="Updating disks ..." />

		<foreach	items="./environment//instance"
					itemName="srv" >
			<updateDisks	target="§[srv]§" />
			<echo message="+ disks updated for instance '§[§[srv]§/@instanceId]§'." />
		</foreach>

		<echo message="-- Disks updated." />		
	</order>

	<order name="create_env" >
		<echo message="Creating instances ..." />

		<foreach	items="./environment//instance"
					itemName="srv" >
			<newMachine	target="§[srv]§" />
			<property name="adm_ip" value="§[ melody:getManagementHost(§[srv]§) ]§" />
			<echo message="+ instance '§[§[srv]§/@instanceId]§' created (IP: §[adm_ip]§)." />
		</foreach>

		<echo message="-- All instances created." />
<!--
		<call orders="ingress" />
 -->
		<call orders="update_disks" />

 	</order>
		
	<order name="stop_env" >
		<echo message="Stopping instances ..." />

		<foreach	items="./environment//instance"
					itemName="srv" >
			<stopMachine	target="§[srv]§" />
			<echo message="+ instance '§[§[srv]§/@instanceId]§' stopped." />
		</foreach>

		<echo message="-- All instances stopped." />

		<call orders="ingress" />
	</order>
	
	<order name="resize_env" >
		<echo message="Resing instances ..." />

		<foreach	items="./environment//instance"
					itemName="srv" >
			<resizeMachine	target="§[srv]§" instanceType="m1.small" />
			<echo message="+ instance '§[§[srv]§/@instanceId]§' resized." />
		</foreach>

		<echo message="-- All instances resized." />
	</order>

	<order name="start_env" >
		<echo message="Starting instances ..." />

		<foreach	items="./environment//instance"
					itemName="srv" >
			<startMachine	target="§[srv]§" />
			<property name="adm_ip" value="§[ melody:getManagementHost(§[srv]§) ]§" />
			<echo message="+ instance '§[§[srv]§/@instanceId]§' started (IP: §[adm_ip]§)." />
		</foreach>

		<echo message="-- All instances started." />

		<call orders="ingress" />
	</order>
	
	<order name="destroy_env" >
		<echo message="Destroying instances ..." />

		<foreach	items="./environment//instance"
					itemName="srv" >
			<property name="id" value="§[§[srv]§/@instanceId]§" />
			<deleteMachine	target="§[srv]§" />
			<echo message="+ instance '§[id]§' destroyed." />
		</foreach>

		<echo message="-- All instances destroyed." />
<!--
		<call orders="ingress" />
-->
	</order>
	
	<order name="all" >
		<call	orders="create_env" />
		<sleep	millis="2000" />
		<call	orders="stop_env" />
		<sleep	millis="2000" />
		<call	orders="start_env" />
		<sleep	millis="2000" />
		<call	orders="destroy_env" />
	</order>

</sequence>
